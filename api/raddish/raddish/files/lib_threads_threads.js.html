---
layout: default
---

<div class="api">
    <aside class="sidebar">
        <ul>
                <li {% if page.url == '../classes/AbstractAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractAdapter.html">
                        AbstractAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/AbstractDispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractDispatcher.html">
                        AbstractDispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Application.html' %} class="active" {% endif %}>
                    <a href="../classes/Application.html">
                        Application
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandBehavior.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandBehavior.html">
                        CommandBehavior
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandChain.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandChain.html">
                        CommandChain
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandContext.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandContext.html">
                        CommandContext
                    </a>
                </li>
                <li {% if page.url == '../classes/Controller.html' %} class="active" {% endif %}>
                    <a href="../classes/Controller.html">
                        Controller
                    </a>
                </li>
                <li {% if page.url == '../classes/ControllerAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ControllerAbstract.html">
                        ControllerAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/DefaultAuthenticator.html' %} class="active" {% endif %}>
                    <a href="../classes/DefaultAuthenticator.html">
                        DefaultAuthenticator
                    </a>
                </li>
                <li {% if page.url == '../classes/Dispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/Dispatcher.html">
                        Dispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Inflector.html' %} class="active" {% endif %}>
                    <a href="../classes/Inflector.html">
                        Inflector
                    </a>
                </li>
                <li {% if page.url == '../classes/Mixin.html' %} class="active" {% endif %}>
                    <a href="../classes/Mixin.html">
                        Mixin
                    </a>
                </li>
                <li {% if page.url == '../classes/Model.html' %} class="active" {% endif %}>
                    <a href="../classes/Model.html">
                        Model
                    </a>
                </li>
                <li {% if page.url == '../classes/ModelAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ModelAbstract.html">
                        ModelAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/MongoAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MongoAdapter.html">
                        MongoAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/MysqlAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MysqlAdapter.html">
                        MysqlAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectIdentifier.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectIdentifier.html">
                        ObjectIdentifier
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectLoader.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectLoader.html">
                        ObjectLoader
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectManager.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectManager.html">
                        ObjectManager
                    </a>
                </li>
                <li {% if page.url == '../classes/Plugin.html' %} class="active" {% endif %}>
                    <a href="../classes/Plugin.html">
                        Plugin
                    </a>
                </li>
                <li {% if page.url == '../classes/RaddishError.html' %} class="active" {% endif %}>
                    <a href="../classes/RaddishError.html">
                        RaddishError
                    </a>
                </li>
                <li {% if page.url == '../classes/Role.html' %} class="active" {% endif %}>
                    <a href="../classes/Role.html">
                        Role
                    </a>
                </li>
                <li {% if page.url == '../classes/Router.html' %} class="active" {% endif %}>
                    <a href="../classes/Router.html">
                        Router
                    </a>
                </li>
                <li {% if page.url == '../classes/Row.html' %} class="active" {% endif %}>
                    <a href="../classes/Row.html">
                        Row
                    </a>
                </li>
                <li {% if page.url == '../classes/RowAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowAbstract.html">
                        RowAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Rowset.html' %} class="active" {% endif %}>
                    <a href="../classes/Rowset.html">
                        Rowset
                    </a>
                </li>
                <li {% if page.url == '../classes/RowsetAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowsetAbstract.html">
                        RowsetAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Socket.html' %} class="active" {% endif %}>
                    <a href="../classes/Socket.html">
                        Socket
                    </a>
                </li>
                <li {% if page.url == '../classes/SqliteAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/SqliteAdapter.html">
                        SqliteAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/States.html' %} class="active" {% endif %}>
                    <a href="../classes/States.html">
                        States
                    </a>
                </li>
                <li {% if page.url == '../classes/Table.html' %} class="active" {% endif %}>
                    <a href="../classes/Table.html">
                        Table
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewAbstract.html">
                        ViewAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewJson.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewJson.html">
                        ViewJson
                    </a>
                </li>
        </ul>    </aside>

    <article>
        <h1 class="file-heading">File: lib/threads/threads.js</h1>
        
        <div class="file">
            <pre class="code prettyprint linenums">
        &quot;use strict&quot;;
        
        /**
         * The Threads class will scale the amount of processes when the load is higher.
         * This will be done completely automatic.
         *
         * And in the config file you can turn this on or off and set more data.
         * This must scale automatically.
         *
         * Also this class will be a little bit like cluster2.
         *
         * If a process activity is higher than 50% we will spawn a new process to lighten the tasks.
         */
        var cluster = require(&#x27;cluster&#x27;),
            usage   = require(&#x27;usage&#x27;),
            threads = [],
            config = {
                maxThreads: 16,
                maxThreshold: 50,
                minThreshold: 10,
                interval: 500
            },
            master = undefined;
        
        /**
         * This object is automatically started when thread support is enabled.
         *
         * @constructor
         */
        function Threads() {
            var threadsConfig = Raddish.getConfig(&#x27;threads&#x27;);
            var isWin = /^win/.test(process.platform);
        
            if(threadsConfig !== false &amp;&amp; !isWin) {
                if(cluster.isMaster) {
                    console.log(&#x27;Threads support enabled!&#x27;);
        
                    master = cluster;
                    threads.push(cluster.fork());
                }
        
                if(threadsConfig.maxThreads) {
                    config.maxThreads = threadsConfig.maxThreads;
                }
        
                if(threadsConfig.maxThreshold) {
                    config.maxThreshold = threadsConfig.maxThreshold;
                }
        
                if(threadsConfig.minThreshold) {
                    config.minThreshold = threadsConfig.minThreshold;
                }
        
                if(threadsConfig.interval) {
                    config.interval = threadsConfig.interval
                }
        
                setInterval(this.checkThreads, config.interval);
            } else if(threadsConfig !== false &amp;&amp; isWin) {
                console.log(&#x27;Threads not supported in Windows&#x27;);
            }
        };
        
        /**
         * This method will check the registred threads and if the thread is too busy
         * another thread will be spawn automatically.
         *
         * When the threads are not busy at all, the last added thread will be closed automatically.
         *
         * @method checkThreads
         */
        Threads.prototype.checkThreads = function() {
            // We will hold our own threads.
            var mean        = 0;
            var total       = threads.length;
            var collection  = [];
        
            for(var index in threads) {
                var thread = threads[index];
        
                var promise = new Promise(function(resolve, reject) {
                    usage.lookup(thread.process.pid, function(err, result) {
                        if(err) {
                            return reject(err);
                        }
        
                        mean += result.cpu;
                        resolve();
                    });
                });
        
                collection.push(promise);
            }
        
            Promise.all(collection)
                .then(function() {
                    if((mean / total) &gt; config.maxThreshold &amp;&amp; total &lt; config.maxThreads) {
        
                        console.log(&#x27;Spawning new process!&#x27;);
                        threads.push(master.fork());
                    } else if((mean / total) &lt; config.minThreshold &amp;&amp; total &gt; 1) {
                        var thread = threads.pop();
        
                        console.log(&#x27;Killing process!&#x27;);
                        thread.kill();
                    }
                });
        };
        
        module.exports = new Threads();
            </pre>
        </div>
    </article>
</div>