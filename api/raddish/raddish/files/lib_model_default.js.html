---
layout: default
---

<div class="api">
    <aside class="sidebar">
        <ul>
                <li {% if page.url == '../classes/AbstractAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractAdapter.html">
                        AbstractAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/AbstractDispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractDispatcher.html">
                        AbstractDispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Application.html' %} class="active" {% endif %}>
                    <a href="../classes/Application.html">
                        Application
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandBehavior.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandBehavior.html">
                        CommandBehavior
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandChain.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandChain.html">
                        CommandChain
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandContext.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandContext.html">
                        CommandContext
                    </a>
                </li>
                <li {% if page.url == '../classes/Controller.html' %} class="active" {% endif %}>
                    <a href="../classes/Controller.html">
                        Controller
                    </a>
                </li>
                <li {% if page.url == '../classes/ControllerAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ControllerAbstract.html">
                        ControllerAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/DefaultAuthenticator.html' %} class="active" {% endif %}>
                    <a href="../classes/DefaultAuthenticator.html">
                        DefaultAuthenticator
                    </a>
                </li>
                <li {% if page.url == '../classes/Dispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/Dispatcher.html">
                        Dispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Inflector.html' %} class="active" {% endif %}>
                    <a href="../classes/Inflector.html">
                        Inflector
                    </a>
                </li>
                <li {% if page.url == '../classes/Mixin.html' %} class="active" {% endif %}>
                    <a href="../classes/Mixin.html">
                        Mixin
                    </a>
                </li>
                <li {% if page.url == '../classes/Model.html' %} class="active" {% endif %}>
                    <a href="../classes/Model.html">
                        Model
                    </a>
                </li>
                <li {% if page.url == '../classes/ModelAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ModelAbstract.html">
                        ModelAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/MongoAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MongoAdapter.html">
                        MongoAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/MysqlAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MysqlAdapter.html">
                        MysqlAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectIdentifier.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectIdentifier.html">
                        ObjectIdentifier
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectLoader.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectLoader.html">
                        ObjectLoader
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectManager.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectManager.html">
                        ObjectManager
                    </a>
                </li>
                <li {% if page.url == '../classes/Plugin.html' %} class="active" {% endif %}>
                    <a href="../classes/Plugin.html">
                        Plugin
                    </a>
                </li>
                <li {% if page.url == '../classes/RaddishError.html' %} class="active" {% endif %}>
                    <a href="../classes/RaddishError.html">
                        RaddishError
                    </a>
                </li>
                <li {% if page.url == '../classes/Role.html' %} class="active" {% endif %}>
                    <a href="../classes/Role.html">
                        Role
                    </a>
                </li>
                <li {% if page.url == '../classes/Router.html' %} class="active" {% endif %}>
                    <a href="../classes/Router.html">
                        Router
                    </a>
                </li>
                <li {% if page.url == '../classes/Row.html' %} class="active" {% endif %}>
                    <a href="../classes/Row.html">
                        Row
                    </a>
                </li>
                <li {% if page.url == '../classes/RowAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowAbstract.html">
                        RowAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Rowset.html' %} class="active" {% endif %}>
                    <a href="../classes/Rowset.html">
                        Rowset
                    </a>
                </li>
                <li {% if page.url == '../classes/RowsetAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowsetAbstract.html">
                        RowsetAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Socket.html' %} class="active" {% endif %}>
                    <a href="../classes/Socket.html">
                        Socket
                    </a>
                </li>
                <li {% if page.url == '../classes/SqliteAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/SqliteAdapter.html">
                        SqliteAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/States.html' %} class="active" {% endif %}>
                    <a href="../classes/States.html">
                        States
                    </a>
                </li>
                <li {% if page.url == '../classes/Table.html' %} class="active" {% endif %}>
                    <a href="../classes/Table.html">
                        Table
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewAbstract.html">
                        ViewAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewJson.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewJson.html">
                        ViewJson
                    </a>
                </li>
        </ul>    </aside>

    <article>
        <h1 class="file-heading">File: lib/model/default.js</h1>
        
        <div class="file">
            <pre class="code prettyprint linenums">
        &quot;use strict&quot;;
        
        var ModelAbstract   = require(&#x27;./abstract&#x27;),
            util            = require(&#x27;util&#x27;),
            clone           = require(&#x27;clone&#x27;);
        
        /**
         * Default model used in most cases.
         *
         * @class Model
         * @extends ModelAbstract
         * @param config The config object.
         * @constructor
         */
        function Model(config) {
            ModelAbstract.call(this, config);
        }
        
        util.inherits(Model, ModelAbstract);
        
        Model.prototype.initialize = function (config) {
            var self = this;
        
            return Model.super_.prototype.initialize.call(self, config)
                .then(function () {
                    return self.getTable();
                })
                .then(function (table) {
                    return table.getUniqueColumns();
                })
                .then(function (columns) {
                    for(var index in columns) {
                        self.states.insert(index, columns[index].type, null, true);
                    }
        
                    return self;
                });
        };
        
        /**
         * getItem override of AbstractModel, this will create a complete query and execute this query on the table.
         *
         * @method getItem
         * @returns {Promise} The promise with a single item from the table as content.
         */
        Model.prototype.getItem = function () {
            var self = this;
        
            return Model.super_.prototype.getItem.call(this)
                .then(function() {
                    if(self.states.isUnique()) {
                        return self.getTable()
                            .then(function (table) {
                                return [table.getQuery(), table];
                            })
                            .spread(function(query, table) {
                                return Promise.cast(query.select())
                                    .then(self.buildQueryColumns.bind(self))
                                    .then(self.buildQueryFrom.bind(self))
                                    .then(self.buildQueryJoins.bind(self))
                                    .then(self.buildQueryWhere.bind(self))
                                    .then(self.buildQueryGroup.bind(self))
                                    .then(self.buildQueryHaving.bind(self))
                                    .then(function(query) {
                                        return [query, table];
                                    });
                            })
                            .spread(function (query, table) {
                                return table.select(query, 1);
                            });
                    } else {
                        return self.getTable()
                            .then(function (table) {
                                return table.getRow();
                            });
                    }
                });
        };
        
        /**
         * This method will retreive a complete list of objects from the table,
         * this will also create a query using the buildQuery methods.
         *
         * @method getList
         * @returns {Promise} A promise with the list of object as content
         */
        Model.prototype.getList = function () {
            var self = this;
        
            return Model.super_.prototype.getList.call(this)
                .then(function() {
                    return self.getTable();
                })
                .then(function (table) {
                    return [table.getQuery(), table];
                })
                .spread(function (query, table) {
                    return Promise.cast(query.select())
                        .then(self.buildQueryColumns.bind(self))
                        .then(self.buildQueryFrom.bind(self))
                        .then(self.buildQueryJoins.bind(self))
                        .then(self.buildQueryWhere.bind(self))
                        .then(self.buildQueryGroup.bind(self))
                        .then(self.buildQueryHaving.bind(self))
                        .then(self.buildQueryOrder.bind(self))
                        .then(self.buildQueryLimit.bind(self))
                        .then(function(query) {
                            return [query, table];
                        });
                })
                .spread(function (query, table) {
                    return table.select(query, 2);
                });
        };
        
        /**
         * A special query is being build to get the total of objects from the table.
         *
         * @method getTotal
         * @returns {Promise} A promise holding the total number of objects as content.
         */
        Model.prototype.getTotal = function () {
            var self = this;
        
            return self.getTable()
                .then(function (table) {
                    return [table.getQuery(), table];
                })
                .spread(function (query, table) {
                    return Promise.cast(query.select())
                        .then(self.buildQueryColumns.bind(self))
                        .then(self.buildQueryFrom.bind(self))
                        .then(self.buildQueryJoins.bind(self))
                        .then(self.buildQueryWhere.bind(self))
                        .then(self.buildQueryGroup.bind(self))
                        .then(self.buildQueryOrder.bind(self))
                        .then(function(query) {
                            return [query, table];
                        });
                })
                .spread(function (query, table) {
                    query.count();
        
                    return table.select(query, 3);
                })
                .then(function(data) {
                    return data[0][&#x27;COUNT(*)&#x27;];
                });
        };
        
        /**
         * buildQueryColumns will determine which columns need to be fetched from the table.
         * by default this is &quot;tbl.*&quot;
         *
         * @method buildQueryColumns
         * @param {Object} query The querybuilder object
         * @param {Object} self Property pointing to the model object.
         * @returns {Array} An array containing query and self, in this order.
         */
        Model.prototype.buildQueryColumns = function (query) {
            query.columns(&#x27;tbl.*&#x27;);
        
            return query;
        };
        
        /**
         * The buildQuiryFrom method will determin from which table the data needs to be fetched.
         * This table will get the alias &quot;tbl&quot; by default.
         *
         * @method buildQueryFrom
         * @param {Object} query The querybuilder object
         * @param {Object} self Property pointing to the model object.
         * @returns {Array} An array containing query and self, in this order.
         */
        Model.prototype.buildQueryFrom = function (query) {
            return this.getTable()
                .then(function(table) {
                    query.table(table.getName(), &#x27;tbl&#x27;);
        
                    return query;
                });
        };
        
        /**
         * The buildQueryJoins will define which joins need to be made.
         * By default no joins are made.
         *
         * @method buildQueryJoins
         * @param {Object} query The querybuilder object
         * @param {Object} self Property pointing to the model object.
         * @returns {Array} An array containing query and self, in this order.
         */
        Model.prototype.buildQueryJoins = function (query) {
            return query;
        };
        
        /**
         * The buildQueryWhere will create the where statements on the query.
         * By default unique states are filtered, this only happens when they have a value.
         *
         * @method buildQueryWhere
         * @param {Object} query The querybuilder object
         * @param {Object} self Property pointing to the model object.
         * @returns {Array} An array containing query and self, in this order.
         */
        Model.prototype.buildQueryWhere = function (query) {
            var states = clone(this.states.get());
        
            return this.getTable()
                .then(function(table) {
                    states = table.mapColumns(states);
                    
                    for(var index in states) {
                        if (states[index].unique &amp;&amp; states[index].value) {
                            query.where(&#x27;tbl.&#x27; + index, &#x27;=&#x27;, states[index].value);
                        }
                    }
        
                    return query;
                });
        };
        
        /**
         * The buildQueryGroup will group the row together.
         * By default no group query is made.
         *
         * @method buildQueryGroup
         * @param {Object} query The querybuilder object
         * @param {Object} self Property pointing to the model object.
         * @returns {Array} An array containing query and self, in this order.
         */
        Model.prototype.buildQueryGroup = function (query) {
            return query;
        };
        
        /**
         * The buildQueryHaving will add a having statement to the query.
         * By default no having statements will be added.
         *
         * @method buildQueryHaving
         * @param {Object} query The querybuilder object
         * @param {Object} self Property pointing to the model object.
         * @returns {Array} An array containing query and self, in this order.
         */
        Model.prototype.buildQueryHaving = function (query) {
            return query;
        };
        
        /**
         * The buildQueryOrder will determine the order and direction on which to sort.
         * By default the state sort and direction are used.
         * When the state sort has a value this value is used, and by default the order is ascending,
         * unless the direction state has been modified.
         *
         * @method buildQueryOrder
         * @param {Object} query The querybuilder object
         * @param {Object} self Property pointing to the model object.
         * @returns {Array} An array containing query and self, in this order.
         */
        Model.prototype.buildQueryOrder = function (query) {
            var order = this.states.get(&#x27;sort&#x27;);
            var direction = this.states.get(&#x27;direction&#x27;);
        
            if(order.value) {
                query.order(order.value, direction.value);
            }
        
            return query;
        };
        
        /**
         * BuildQueryLimit will use the limit and offset states to return the records
         * When both aren&#x27;t specified the default of limit is &quot;20&quot; and the default of offset is &quot;0&quot;.
         *
         * @method buildQueryLimit
         * @param {Object} query The querybuilder object
         * @param {Object} self Property pointing to the model object.
         * @returns {Array} An array containing query and self, in this order.
         */
        Model.prototype.buildQueryLimit = function (query) {
            var limit = this.states.get(&#x27;limit&#x27;);
            var offset = this.states.get(&#x27;offset&#x27;);
        
            if (limit.value &gt; 0) {
                query.limit(limit.value);
            }
        
            if (offset.value &gt; 0) {
                query.offset(offset.value);
            }
        
            return query;
        };
        
        module.exports = Model;
            </pre>
        </div>
    </article>
</div>