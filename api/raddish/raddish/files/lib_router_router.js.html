---
layout: default
---

<div class="api">
    <aside class="sidebar">
        <ul>
                <li {% if page.url == '../classes/AbstractAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractAdapter.html">
                        AbstractAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/AbstractDispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractDispatcher.html">
                        AbstractDispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Application.html' %} class="active" {% endif %}>
                    <a href="../classes/Application.html">
                        Application
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandBehavior.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandBehavior.html">
                        CommandBehavior
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandChain.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandChain.html">
                        CommandChain
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandContext.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandContext.html">
                        CommandContext
                    </a>
                </li>
                <li {% if page.url == '../classes/Controller.html' %} class="active" {% endif %}>
                    <a href="../classes/Controller.html">
                        Controller
                    </a>
                </li>
                <li {% if page.url == '../classes/ControllerAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ControllerAbstract.html">
                        ControllerAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/DefaultAuthenticator.html' %} class="active" {% endif %}>
                    <a href="../classes/DefaultAuthenticator.html">
                        DefaultAuthenticator
                    </a>
                </li>
                <li {% if page.url == '../classes/Dispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/Dispatcher.html">
                        Dispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Inflector.html' %} class="active" {% endif %}>
                    <a href="../classes/Inflector.html">
                        Inflector
                    </a>
                </li>
                <li {% if page.url == '../classes/Mixin.html' %} class="active" {% endif %}>
                    <a href="../classes/Mixin.html">
                        Mixin
                    </a>
                </li>
                <li {% if page.url == '../classes/Model.html' %} class="active" {% endif %}>
                    <a href="../classes/Model.html">
                        Model
                    </a>
                </li>
                <li {% if page.url == '../classes/ModelAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ModelAbstract.html">
                        ModelAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/MongoAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MongoAdapter.html">
                        MongoAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/MysqlAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MysqlAdapter.html">
                        MysqlAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectIdentifier.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectIdentifier.html">
                        ObjectIdentifier
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectLoader.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectLoader.html">
                        ObjectLoader
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectManager.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectManager.html">
                        ObjectManager
                    </a>
                </li>
                <li {% if page.url == '../classes/Plugin.html' %} class="active" {% endif %}>
                    <a href="../classes/Plugin.html">
                        Plugin
                    </a>
                </li>
                <li {% if page.url == '../classes/RaddishError.html' %} class="active" {% endif %}>
                    <a href="../classes/RaddishError.html">
                        RaddishError
                    </a>
                </li>
                <li {% if page.url == '../classes/Role.html' %} class="active" {% endif %}>
                    <a href="../classes/Role.html">
                        Role
                    </a>
                </li>
                <li {% if page.url == '../classes/Router.html' %} class="active" {% endif %}>
                    <a href="../classes/Router.html">
                        Router
                    </a>
                </li>
                <li {% if page.url == '../classes/Row.html' %} class="active" {% endif %}>
                    <a href="../classes/Row.html">
                        Row
                    </a>
                </li>
                <li {% if page.url == '../classes/RowAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowAbstract.html">
                        RowAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Rowset.html' %} class="active" {% endif %}>
                    <a href="../classes/Rowset.html">
                        Rowset
                    </a>
                </li>
                <li {% if page.url == '../classes/RowsetAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowsetAbstract.html">
                        RowsetAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Socket.html' %} class="active" {% endif %}>
                    <a href="../classes/Socket.html">
                        Socket
                    </a>
                </li>
                <li {% if page.url == '../classes/SqliteAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/SqliteAdapter.html">
                        SqliteAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/States.html' %} class="active" {% endif %}>
                    <a href="../classes/States.html">
                        States
                    </a>
                </li>
                <li {% if page.url == '../classes/Table.html' %} class="active" {% endif %}>
                    <a href="../classes/Table.html">
                        Table
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewAbstract.html">
                        ViewAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewJson.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewJson.html">
                        ViewJson
                    </a>
                </li>
        </ul>    </aside>

    <article>
        <h1 class="file-heading">File: lib/router/router.js</h1>
        
        <div class="file">
            <pre class="code prettyprint linenums">
        &quot;use strict&quot;;
        
        var fs          = require(&#x27;fs&#x27;),
            zlib        = require(&#x27;zlib&#x27;),
            url         = require(&#x27;url&#x27;),
            mime        = require(&#x27;mime&#x27;),
            Inflector   = require(&#x27;../inflector/inflector&#x27;),
            Application = require(&#x27;../application/application&#x27;);
        
        /**
         * Router object, this will route the request to the application.
         *
         * @class Router
         * @constructor
         */
        function Router () {
        
        }
        
        /**
         * This method will check if the request is a file, if so it will return the file,
         * if not it will try to find an application and will try to run the component.
         *
         * When a file is found and the gzip option in the config is true it will send a gzipped response.
         *
         * @method route
         * @param {Object} req NodeJS request object
         * @param {Object} res NodeJS response object
         */
        Router.prototype.route = function(req, res) {
            var self = this;
        
            Promise.cast([req, res])
                .spread(this.getRoute)
                .spread(this.checkCors)
                .spread(this.checkFile)
                .spread(this.parseRequest)
                .spread(this.request);
        };
        
        /**
         * This method will try to match a route to the current request.
         *
         * @method getRoute
         * @param req
         * @param res
         * @returns {*[]}
         */
        Router.prototype.getRoute = function(req, res) {
            var routes = Raddish.getConfig(&#x27;router.routes&#x27;);
        
            if (req.url === &#x27;/&#x27;) {
                req.url = &#x27;/index.html&#x27;;
            }
        
            for (var index in routes) {
                var route = index.split(&#x27;/&#x27;),
                    uri = url.parse(req.url, true),
                    parts = uri.path.split(&#x27;/&#x27;);
        
                if (req.url == index) {
                    req.url = routes[index];
                } else if (route[route.length - 1] === &#x27;*&#x27;) {
                    route.pop();
        
                    if (uri.path.indexOf(route.join(&#x27;/&#x27;)) === 0) {
                        uri.pathname = uri.pathname.replace(route.join(&#x27;/&#x27;), routes[index]).replace(&#x27;//&#x27;, &#x27;/&#x27;);
        
                        req.url = url.format(uri);
                    }
                } else if (parts.length == route.length) {
                    var isFalse = false;
        
                    for(var idx in route) {
                        if(route[idx].charAt(0) != &#x27;:&#x27; &amp;&amp; route[idx] != parts[idx]) {
                            isFalse = true;
                        } else if(route[idx].charAt(0) === &#x27;:&#x27;) {
                            uri.query[route[idx].substring(1)] = parts[idx];
                        }
                    }
        
                    if(isFalse) {
                        continue;
                    }
        
                    uri.pathname = routes[index];
                    req.url = url.format(uri);
                }
            }
        
            return [req, res];
        };
        
        /**
         * This method will set the CORS headers to the response.
         *
         * @method checkCors
         * @param {Object} req Nodejs Request Object
         * @param {Object} res Nodejs Response Object
         * @returns {*[]}
         */
        Router.prototype.checkCors = function(req, res) {
            var cors = Raddish.getConfig(&#x27;router.cors&#x27;);
        
            if(cors) {
                if(cors.origin.join) {
                    cors.origin = cors.origin.join(&#x27;,&#x27;);
                }
        
                if(cors.methods.join) {
                    cors.methods = cors.methods.join(&#x27;,&#x27;);
                }
        
                if(cors.credentials) {
                    res.setHeader(&#x27;Access-Control-Allow-Credentials&#x27;, &#x27;true&#x27;);
                }
        
                if(cors.headers.join) {
                    cors.headers = cors.headers.join(&#x27;,&#x27;);
                }
        
                res.setHeader(&#x27;Access-Control-Allow-Origin&#x27;, cors.origin);
                res.setHeader(&#x27;Access-Control-Allow-Methods&#x27;, cors.methods);
                res.setHeader(&#x27;Access-Control-Allow-Headers&#x27;, cors.headers);
            }
        
            return [req, res];
        };
        
        /**
         * This method will check if the request is going to a direct file, if so return it.
         * If gzip is enabled and supported it will gzip the response.
         *
         * @method checkFile
         * @param {Object} req Nodejs Request Object
         * @param {Object} res Nodejs Response Object
         * @returns {Promise}
         */
        Router.prototype.checkFile = function(req, res) {
            var self = this;
        
            return new Promise(function(resolve, reject) {
                fs.readFile(process.cwd() + Raddish.getConfig(&#x27;public&#x27;) + req.url, function(err, data) {
                    if(err) {
                        resolve([req, res]);
                    } else {
                        res.setHeader(&#x27;Content-Type&#x27;, mime.lookup(process.cwd() + Raddish.getConfig(&#x27;public&#x27;) + req.url));
        
                        if(Router._checkGZip(req) &amp;&amp; Raddish.getConfig(&#x27;gzip&#x27;)) {
                            res.setHeader(&#x27;Content-Encoding&#x27;, &#x27;gzip&#x27;);
        
                            zlib.gzip(data, function(err, data) {
                                res.end(data);
                            });
                        } else {
                            res.end(data);
                        }
                    }
                });
            });
        };
        
        /**
         * This method will try to parse the request if the request a an API request.
         * By default the app and component parameters must be passed in the request.
         *
         * @method parseRequest
         * @param {Object} req Nodejs Request Object
         * @returns {Object} The parsed request object.
         */
        Router.prototype.parseRequest = function (req, res) {
            req.url = url.parse(req.url, true);
            var pathparts = req.url.pathname.split(&#x27;/&#x27;);
            pathparts.shift();
        
            if (pathparts[0]) {
                req.url.query[&#x27;app&#x27;] = pathparts[0];
            }
        
            if (pathparts[1]) {
                req.url.query[&#x27;component&#x27;] = pathparts[1];
            }
        
            if (pathparts[2]) {
                req.url.query[&#x27;view&#x27;] = pathparts[2];
            }
        
            return [req, res];
        };
        
        /**
         * This method will do the request to the framework to receive the data.
         *
         * @param {Object} req Nodejs Request Object
         * @param {Object} res Nodejs Response Object
         */
        Router.prototype.request = function(req, res) {
            try {
                var app = Application.matchApplication(req.url);
                app.runComponent(req.url.query.component, req, res);
            } catch(error) {
                if(error instanceof RaddishError) {
                    res.statusCode = error.code;
                    res.end(JSON.stringify({
                        &#x27;code&#x27;: error.code,
                        &#x27;message&#x27;: error.message,
                        &#x27;stack&#x27;: error.stack
                    }));
                }
            }
        };
        
        /**
         * This method will check if the gzip value is in the request accept-encoding header,
         * if so return true else return false.
         *
         * @private
         * @param {Object} req NodeJS request object.
         * @returns {Boolean}
         */
        Router._checkGZip = function (req) {
            if(req.headers[&#x27;accept-encoding&#x27;]) {
                return (req.headers[&#x27;accept-encoding&#x27;].search(&#x27;gzip&#x27;) !== false ? true : false)
            } else {
                return false;
            }
        };
        
        module.exports = Router;
            </pre>
        </div>
    </article>
</div>