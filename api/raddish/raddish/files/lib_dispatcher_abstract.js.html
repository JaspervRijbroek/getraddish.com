---
layout: default
---

<div class="api">
    <aside class="sidebar">
        <ul>
                <li {% if page.url == '../classes/AbstractAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractAdapter.html">
                        AbstractAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/AbstractDispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractDispatcher.html">
                        AbstractDispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Application.html' %} class="active" {% endif %}>
                    <a href="../classes/Application.html">
                        Application
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandBehavior.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandBehavior.html">
                        CommandBehavior
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandChain.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandChain.html">
                        CommandChain
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandContext.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandContext.html">
                        CommandContext
                    </a>
                </li>
                <li {% if page.url == '../classes/Controller.html' %} class="active" {% endif %}>
                    <a href="../classes/Controller.html">
                        Controller
                    </a>
                </li>
                <li {% if page.url == '../classes/ControllerAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ControllerAbstract.html">
                        ControllerAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/DefaultAuthenticator.html' %} class="active" {% endif %}>
                    <a href="../classes/DefaultAuthenticator.html">
                        DefaultAuthenticator
                    </a>
                </li>
                <li {% if page.url == '../classes/Dispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/Dispatcher.html">
                        Dispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Inflector.html' %} class="active" {% endif %}>
                    <a href="../classes/Inflector.html">
                        Inflector
                    </a>
                </li>
                <li {% if page.url == '../classes/Mixin.html' %} class="active" {% endif %}>
                    <a href="../classes/Mixin.html">
                        Mixin
                    </a>
                </li>
                <li {% if page.url == '../classes/Model.html' %} class="active" {% endif %}>
                    <a href="../classes/Model.html">
                        Model
                    </a>
                </li>
                <li {% if page.url == '../classes/ModelAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ModelAbstract.html">
                        ModelAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/MongoAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MongoAdapter.html">
                        MongoAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/MysqlAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MysqlAdapter.html">
                        MysqlAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectIdentifier.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectIdentifier.html">
                        ObjectIdentifier
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectLoader.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectLoader.html">
                        ObjectLoader
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectManager.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectManager.html">
                        ObjectManager
                    </a>
                </li>
                <li {% if page.url == '../classes/Plugin.html' %} class="active" {% endif %}>
                    <a href="../classes/Plugin.html">
                        Plugin
                    </a>
                </li>
                <li {% if page.url == '../classes/RaddishError.html' %} class="active" {% endif %}>
                    <a href="../classes/RaddishError.html">
                        RaddishError
                    </a>
                </li>
                <li {% if page.url == '../classes/Role.html' %} class="active" {% endif %}>
                    <a href="../classes/Role.html">
                        Role
                    </a>
                </li>
                <li {% if page.url == '../classes/Router.html' %} class="active" {% endif %}>
                    <a href="../classes/Router.html">
                        Router
                    </a>
                </li>
                <li {% if page.url == '../classes/Row.html' %} class="active" {% endif %}>
                    <a href="../classes/Row.html">
                        Row
                    </a>
                </li>
                <li {% if page.url == '../classes/RowAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowAbstract.html">
                        RowAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Rowset.html' %} class="active" {% endif %}>
                    <a href="../classes/Rowset.html">
                        Rowset
                    </a>
                </li>
                <li {% if page.url == '../classes/RowsetAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowsetAbstract.html">
                        RowsetAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Socket.html' %} class="active" {% endif %}>
                    <a href="../classes/Socket.html">
                        Socket
                    </a>
                </li>
                <li {% if page.url == '../classes/SqliteAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/SqliteAdapter.html">
                        SqliteAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/States.html' %} class="active" {% endif %}>
                    <a href="../classes/States.html">
                        States
                    </a>
                </li>
                <li {% if page.url == '../classes/Table.html' %} class="active" {% endif %}>
                    <a href="../classes/Table.html">
                        Table
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewAbstract.html">
                        ViewAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewJson.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewJson.html">
                        ViewJson
                    </a>
                </li>
        </ul>    </aside>

    <article>
        <h1 class="file-heading">File: lib/dispatcher/abstract.js</h1>
        
        <div class="file">
            <pre class="code prettyprint linenums">
        var ObjectManager   = require(&#x27;../object/manager&#x27;),
            util            = require(&#x27;util&#x27;),
            Inflector       = require(&#x27;../inflector/inflector&#x27;),
            zlib            = require(&#x27;zlib&#x27;),
            Formidable      = require(&#x27;formidable&#x27;),
            RaddishStream   = require(&#x27;../stream/stream&#x27;);
        
        /**
         * This is the abstract dispatcher
         * This class contains the default methods.
         *
         * @class AbstractDispatcher
         * @extends ObjectManager
         * @param config
         * @constructor
         */
        function AbstractDispatcher(config) {
            this.authenticator = undefined;
            this.controller = undefined;
        
            ObjectManager.call(this, config);
        }
        
        util.inherits(AbstractDispatcher, ObjectManager);
        
        AbstractDispatcher.prototype.initialize = function(config) {
            var extra = this.getComponentConfig(&#x27;dispatcher&#x27;);
            
            this.controller = config.controller || extra.controller || Inflector.pluralize(this.getIdentifier().getPackage());
            this.authenticator = config.authenticator || extra.authenticator || &#x27;core:dispatcher.authenticator.fallback&#x27;;
        
            return ObjectManager.prototype.initialize.call(this, config);
        };
        
        /**
         * This method will dispatch check the view parameter and get the correct controller,
         * after this the correct action is ran.
         *
         * @method dispatch
         * @param {Object} req NodeJS Request Object
         * @param {Object} res NodeJS Response Object
         * @return {Promise} The promise with the controller as content.
         */
        AbstractDispatcher.prototype.dispatch = function (req, res) {
            var self = this;
        
            return this.getAuthenticator()
                .then(function(authenticator) {
                    return authenticator.authenticate(req);
                })
                .then(function (authenticated) {
                    return [self.getController(req), self.parseRequest(req), authenticated];
                })
                .spread(function (controller, data, authenticated) {
                    var context         = controller.getContext();
                    context.auth        = authenticated;
                    context.request     = controller.getRequest();
                    context.data        = data;
        
                    return controller.execute(data.fields.action || req.method, context);
                });
        };
        
        /**
         * This method will return the Controller object for the request.
         *
         * @method getController
         * @param {Object} req NodeJS Request Object
         * @param {Object} res NodeJS Response Object
         * @returns {Promise} Return the Controller object.
         */
        AbstractDispatcher.prototype.getController = function (req) {
            var identifier = this.getIdentifier().clone();
        
            return this.getObject(identifier.setPath([&#x27;controller&#x27;]).setName(Inflector.singularize(req.url.query.view ? req.url.query.view : this.controller)))
                .then(function(controller) {
                    controller.request      = req.url.query;
                    controller.request.view = req.url.query.view || Inflector.pluralize(controller.getIdentifier().getName());
                    controller.format       = (req.url.query.format || Raddish.getConfig(&#x27;format&#x27;));
        
                    return controller;
                });
        };
        
        /**
         * Get the authenticator belonging to the current dispatcher.
         *
         * @method getAuthenticator
         * @returns {Promise} The promised authenticator
         */
        AbstractDispatcher.prototype.getAuthenticator = function() {
            if(this.authenticator.indexOf(&#x27;:&#x27;) == -1 ) {
                var name = this.authenticator;
                var path = this.getIdentifier().getPath();
                path.push(&#x27;authenticator&#x27;);
                
                this.authenticator = this.getIdentifier().clone().setPath(path).setName(name);
            }
            
            return this.getObject(this.authenticator);
        };
        
        /**
         * This method will parse the request and returns the fields and files send in the request.
         *
         * @method parseRequest
         * @param {Object} req NodeJS Request Object
         * @returns {Promise} Return the POST data and Files
         */
        AbstractDispatcher.prototype.parseRequest = function (req) {
            var form = new Formidable.IncomingForm();
        
            return new Promise(function(resolve, reject) {
                form.parse(req, function(err, fields, files) {
                    if(err) {
                        return reject(err);
                    }
        
                    return resolve({
                        fields: fields,
                        files: files
                    });
                })
            });
        };
        
        /**
         * This method will check if gzip is enabled and supported, if both are true it will gzip the data and send it to the response.
         *
         * @method GZip
         * @param {Object} req The NodeJS request object
         * @param {Object} res The NodeJS response object
         * @param {Object} data The data object which needs GZipping.
         * @returns {Promise} The encoded response.
         * @private
         */
        AbstractDispatcher.prototype.GZip = function(req, res, data) {
            if(typeof data.pipe != &#x27;function&#x27;) {
                var stream = new RaddishStream();
                stream.cast(data)
                data = stream.stream;
            }
        
            if(req.headers[&#x27;accept-encoding&#x27;] &amp;&amp; req.headers[&#x27;accept-encoding&#x27;].match(/\bgzip\b/) &amp;&amp; Raddish.getConfig(&#x27;gzip&#x27;)) {
                var gzip = zlib.createGzip();
        
                res.setHeader(&#x27;content-encoding&#x27;, &#x27;gzip&#x27;);
                return Promise.cast(data.pipe(gzip));
            } else {
                return Promise.cast(data);
            }
        };
        
        /**
         * This method will handle the exceptions thrown in the framework,
         * if it is an instance of RaddishError it will return it to the browser.
         *
         * @method handleException
         * @param {Object} response NodeJS request object.
         * @param {Object} error The error object.
         */
        AbstractDispatcher.prototype.handleException = function(response, error) {
            if(error instanceof RaddishError) {
                response.setHeader(&#x27;Content-Type&#x27;, &#x27;application/json&#x27;);
                response.statusCode = error.code;
                response.end(JSON.stringify({
                    &#x27;code&#x27;: error.code,
                    &#x27;message&#x27;: error.message,
                    &#x27;stack&#x27;: error.stack
                }));
            } else {
                // Return the default error value.
                console.log(error.stack);
                process.exit(1);
            }
        };
        
        module.exports = AbstractDispatcher;
            </pre>
        </div>
    </article>
</div>