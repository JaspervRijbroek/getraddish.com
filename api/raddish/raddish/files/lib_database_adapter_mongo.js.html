---
layout: default
---

<div class="api">
    <aside class="sidebar">
        <ul>
                <li {% if page.url == '../classes/AbstractAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractAdapter.html">
                        AbstractAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/AbstractDispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractDispatcher.html">
                        AbstractDispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Application.html' %} class="active" {% endif %}>
                    <a href="../classes/Application.html">
                        Application
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandBehavior.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandBehavior.html">
                        CommandBehavior
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandChain.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandChain.html">
                        CommandChain
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandContext.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandContext.html">
                        CommandContext
                    </a>
                </li>
                <li {% if page.url == '../classes/Controller.html' %} class="active" {% endif %}>
                    <a href="../classes/Controller.html">
                        Controller
                    </a>
                </li>
                <li {% if page.url == '../classes/ControllerAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ControllerAbstract.html">
                        ControllerAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/DefaultAuthenticator.html' %} class="active" {% endif %}>
                    <a href="../classes/DefaultAuthenticator.html">
                        DefaultAuthenticator
                    </a>
                </li>
                <li {% if page.url == '../classes/Dispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/Dispatcher.html">
                        Dispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Inflector.html' %} class="active" {% endif %}>
                    <a href="../classes/Inflector.html">
                        Inflector
                    </a>
                </li>
                <li {% if page.url == '../classes/Mixin.html' %} class="active" {% endif %}>
                    <a href="../classes/Mixin.html">
                        Mixin
                    </a>
                </li>
                <li {% if page.url == '../classes/Model.html' %} class="active" {% endif %}>
                    <a href="../classes/Model.html">
                        Model
                    </a>
                </li>
                <li {% if page.url == '../classes/ModelAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ModelAbstract.html">
                        ModelAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/MongoAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MongoAdapter.html">
                        MongoAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/MysqlAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MysqlAdapter.html">
                        MysqlAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectIdentifier.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectIdentifier.html">
                        ObjectIdentifier
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectLoader.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectLoader.html">
                        ObjectLoader
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectManager.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectManager.html">
                        ObjectManager
                    </a>
                </li>
                <li {% if page.url == '../classes/Plugin.html' %} class="active" {% endif %}>
                    <a href="../classes/Plugin.html">
                        Plugin
                    </a>
                </li>
                <li {% if page.url == '../classes/RaddishError.html' %} class="active" {% endif %}>
                    <a href="../classes/RaddishError.html">
                        RaddishError
                    </a>
                </li>
                <li {% if page.url == '../classes/Role.html' %} class="active" {% endif %}>
                    <a href="../classes/Role.html">
                        Role
                    </a>
                </li>
                <li {% if page.url == '../classes/Router.html' %} class="active" {% endif %}>
                    <a href="../classes/Router.html">
                        Router
                    </a>
                </li>
                <li {% if page.url == '../classes/Row.html' %} class="active" {% endif %}>
                    <a href="../classes/Row.html">
                        Row
                    </a>
                </li>
                <li {% if page.url == '../classes/RowAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowAbstract.html">
                        RowAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Rowset.html' %} class="active" {% endif %}>
                    <a href="../classes/Rowset.html">
                        Rowset
                    </a>
                </li>
                <li {% if page.url == '../classes/RowsetAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowsetAbstract.html">
                        RowsetAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Socket.html' %} class="active" {% endif %}>
                    <a href="../classes/Socket.html">
                        Socket
                    </a>
                </li>
                <li {% if page.url == '../classes/SqliteAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/SqliteAdapter.html">
                        SqliteAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/States.html' %} class="active" {% endif %}>
                    <a href="../classes/States.html">
                        States
                    </a>
                </li>
                <li {% if page.url == '../classes/Table.html' %} class="active" {% endif %}>
                    <a href="../classes/Table.html">
                        Table
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewAbstract.html">
                        ViewAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewJson.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewJson.html">
                        ViewJson
                    </a>
                </li>
        </ul>    </aside>

    <article>
        <h1 class="file-heading">File: lib/database/adapter/mongo.js</h1>
        
        <div class="file">
            <pre class="code prettyprint linenums">
        var Abstract    = require(&#x27;./abstract&#x27;),
            util        = require(&#x27;util&#x27;),
            query       = require(&#x27;universal-query&#x27;),
            mongo       = require(&#x27;mongodb&#x27;).MongoClient,
            Filter      = require(&#x27;../../filter/filter&#x27;),
            instances   = {};
        
        /**
         * The MongoDB database adapter.
         * This adapter will create a connection with the MongoDB server
         *
         * @class MongoAdapter
         * @extends AbstractAdapter
         * @param {Object} config This is the config object for the adapter
         * @param {Object} connection The connection to the server
         * @constructor
         */
        function MongoAdapter(config, connection) {
            MongoAdapter.super_.call(this, config);
        
            this.connection = connection;
            this.strictColumns = false;
        
            this.types = {
        
            };
        
            this.queryBuilder = query.getType(&#x27;mongo&#x27;);
        };
        
        util.inherits(MongoAdapter, Abstract);
        
        /**
         * This function will return a single instance of a server connection.
         * If the connection does not exists it will try to create it.
         *
         * @method getInstance
         * @param {String} name The instance name
         * @param {Object} config The config object for the connection.
         * @returns {Promise} The server connection to use.
         */
        MongoAdapter.prototype.getInstance = function(name, config) {
            var auth = &#x27;&#x27;;
            var self = this;
        
            if(instances[name]) {
                return Promise.resolve(instances[name]);
            } else {
                // We will create our auth string.
                if(config.user &amp;&amp; config.password) {
                    auth = config.user + &#x27;:&#x27; + config.password + &#x27;@&#x27;;
                }
        
                return new Promise(function(resolve, reject) {
                    mongo.connect(&#x27;mongodb://&#x27; + auth + config.host + &#x27;:&#x27; + (config.port || 27017) + &#x27;/&#x27; + config.database, function(err, connection) {
                        if(err) {
                            return reject(err);
                        }
                        
                        return resolve(connection);
                    });
                }).then(function(connection) {
                    instances[name] = new MongoAdapter({
                        identifier: self.getIdentifier()
                    }, connection);
        
                    return instances[name];
                });
        
            }
        };
        
        /**
         * This method will execute a query on the server,
         * the received data is then returned.
         *
         * @param {Object} query The query to be executed
         * @returns {Promise} The promise with the received data
         */
        MongoAdapter.prototype.execute = function(query) {
            // select the collection.
            var self = this;
            var collection = this.connection.collection(query.getTable());
        
            // Function
            var method = query.getMethod();
            
            return new Promise(function(resolve, reject) {
                collection[method](query.toQuery(), function(err, result) {
                    if(err) {
                        return reject(err);
                    }
                    
                    return resolve(result);
                });
            }).then(function(result) {
                if(typeof result.toArray == &#x27;function&#x27;) {
                    if(query.getLimit() &gt; 0) {
                        result.limit(query.getLimit());
        
                        if(query.getOffset()) {
                            result.skip(query.getOffset());
                        }
                    }
                    
                    return new Promise(function (resolve, reject) {
                        result.toArray(function(err, result) {
                            if(err) {
                                return reject(err);
                            }
                            
                            return resolve(result);
                        })
                    })
                } else {
                    if(query.constructor.name == &#x27;InsertQuery&#x27;) {
                        result.insertId = result.ops[0]._id;
                    }
        
                    return result;
                }
            }).catch(function(error) {
                throw new RaddishError(500, error.message);
            });
        
        };
        
        /**
         * This method will create the schema to use.
         *
         * @method getSchema
         * @param {String} name The name of the table to get the schema from.
         * @returns {Promise} The promise containing the schema.
         */
        MongoAdapter.prototype.getSchema = function(name) {
            var result = {};
            var self = this;
        
            return this._fetchInfo(name)
                .then(function(info) {
                    result.info = info;
        
                    return self._fetchIndexes(name);
                })
                .then(function(indexes) {
                    result.indexes = indexes;
        
                    return self._fetchColumns(name);
                })
                .then(function(columns) {
                    result.columns = columns;
        
                    return result;
                });
        };
        
        /**
         * This method will receive various information of the server.
         *
         * @method _fetchInfo
         * @param {String} name The table name from which to return the data.
         * @returns {Promise} The promise with the server information.
         * @private
         */
        MongoAdapter.prototype._fetchInfo = function(name) {
            return Promise.resolve({
                name: name
            });
        };
        
        /**
         * This function will return the indexes on the selected table.
         *
         * @method _fetchIndexes
         * @param {String} name The table name to get the indexed from
         * @returns {Promse} The promise with all the information.
         * @private
         */
        MongoAdapter.prototype._fetchIndexes = function(name) {
            var collection = this.connection.collection(name);
        
            return new Promise(function(resolve, reject) {
                collection.indexes(function(err, indexes) {
                    if(err) {
                        return reject(err);
                    }
        
                    if(indexes.length &lt;= 0) {
                        return resolve([
                            &#x27;_id&#x27;
                        ]);
                    } else {
                        return resolve(indexes);
                    }
                });
            });
        };
        
        /**
         * This method will return the column layout.
         * This column layout will be used in the data responses.
         *
         * @param {String} name The name of the table to get the columns from.
         * @returns {Promise} The promise with the table columns.
         * @private
         */
        MongoAdapter.prototype._fetchColumns = function(name) {
            var collection  = this.connection.collection(name);
            var self        =  this;
        
            return new Promise(function(resolve, reject) {
                collection.find(function(err, rows) {
                    if(err) {
                        return reject(err);
                    }
                    
                    return resolve(rows);
                })
            }).then(function(rows) {
                return new Promise(function(resolve, reject) {
                    rows.toArray(function(err, result) {
                        if(err) {
                            return reject(err);
                        }
                        
                        return resolve(result);
                    });
                });
            }).then(function(rows) {
                var columns = {};
        
                // Always add _id
                columns[&#x27;_id&#x27;] = {
                    name: &#x27;_id&#x27;,
                    unique: true,
                    autoinc: true,
                    value: null,
                    type: &#x27;mongo-id&#x27;,
                    filter: Filter.getFilter(&#x27;mongo-id&#x27;)
                };
        
                for(var index in rows) {
                    var row = rows[index];
        
                    for(var key in row) {
                        var type = getType(row[key]);
                        if(!columns[key]) {
                            columns[key] = {
                                name: key,
                                unique: false,
                                autoinc: false,
                                value: null,
                                type: type,
                                filter: Filter.getFilter(type)
                            };
                        }
                    }
                }
        
                return columns;
            });
        };
        
        /**
         * This function will define the type of the column data.
         *
         * @param {Object} item the item to get the type from.
         * @returns {String} The object type.
         */
        function getType(item) {
            if (Object.prototype.toString.call(item) === &quot;[object Number]&quot;) {
                return &quot;number&quot;;
        
            } else if (Object.prototype.toString.call(item) === &quot;[object String]&quot;) {
                return &quot;string&quot;;
        
            } else if (Object.prototype.toString.call(item) === &quot;[object Date]&quot;) {
                return &quot;date&quot;;
        
            } else if(Object.prototype.toString.call(item) === &#x27;[object Array]&#x27; ) {
                return &quot;array&quot;;
        
            } else if(Object.prototype.toString.call(item) === &#x27;[object Null]&#x27;) {
                return &quot;string&quot;;
        
            } else if(typeof(item)==&quot;object&quot;) {
                for(var index in item) {
                    return index[index];
                }
        
            } else{
                return (typeof item)[0].toUpperCase() + (typeof item).slice(1);
        
            }
        }
        
        module.exports = MongoAdapter;
            </pre>
        </div>
    </article>
</div>