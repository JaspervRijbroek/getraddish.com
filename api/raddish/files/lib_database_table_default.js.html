---
layout: default
---

<div class="api">
    <aside class="sidebar">
        <ul>
                <li {% if page.url == '../classes/AbstractAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractAdapter.html">
                        AbstractAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/AbstractDispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractDispatcher.html">
                        AbstractDispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Application.html' %} class="active" {% endif %}>
                    <a href="../classes/Application.html">
                        Application
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandBehavior.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandBehavior.html">
                        CommandBehavior
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandChain.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandChain.html">
                        CommandChain
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandContext.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandContext.html">
                        CommandContext
                    </a>
                </li>
                <li {% if page.url == '../classes/Controller.html' %} class="active" {% endif %}>
                    <a href="../classes/Controller.html">
                        Controller
                    </a>
                </li>
                <li {% if page.url == '../classes/ControllerAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ControllerAbstract.html">
                        ControllerAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/DefaultAuthenticator.html' %} class="active" {% endif %}>
                    <a href="../classes/DefaultAuthenticator.html">
                        DefaultAuthenticator
                    </a>
                </li>
                <li {% if page.url == '../classes/Dispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/Dispatcher.html">
                        Dispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Inflector.html' %} class="active" {% endif %}>
                    <a href="../classes/Inflector.html">
                        Inflector
                    </a>
                </li>
                <li {% if page.url == '../classes/Mixin.html' %} class="active" {% endif %}>
                    <a href="../classes/Mixin.html">
                        Mixin
                    </a>
                </li>
                <li {% if page.url == '../classes/Model.html' %} class="active" {% endif %}>
                    <a href="../classes/Model.html">
                        Model
                    </a>
                </li>
                <li {% if page.url == '../classes/ModelAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ModelAbstract.html">
                        ModelAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/MongoAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MongoAdapter.html">
                        MongoAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/MysqlAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MysqlAdapter.html">
                        MysqlAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectIdentifier.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectIdentifier.html">
                        ObjectIdentifier
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectLoader.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectLoader.html">
                        ObjectLoader
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectManager.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectManager.html">
                        ObjectManager
                    </a>
                </li>
                <li {% if page.url == '../classes/Plugin.html' %} class="active" {% endif %}>
                    <a href="../classes/Plugin.html">
                        Plugin
                    </a>
                </li>
                <li {% if page.url == '../classes/RaddishError.html' %} class="active" {% endif %}>
                    <a href="../classes/RaddishError.html">
                        RaddishError
                    </a>
                </li>
                <li {% if page.url == '../classes/Role.html' %} class="active" {% endif %}>
                    <a href="../classes/Role.html">
                        Role
                    </a>
                </li>
                <li {% if page.url == '../classes/Router.html' %} class="active" {% endif %}>
                    <a href="../classes/Router.html">
                        Router
                    </a>
                </li>
                <li {% if page.url == '../classes/Row.html' %} class="active" {% endif %}>
                    <a href="../classes/Row.html">
                        Row
                    </a>
                </li>
                <li {% if page.url == '../classes/RowAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowAbstract.html">
                        RowAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Rowset.html' %} class="active" {% endif %}>
                    <a href="../classes/Rowset.html">
                        Rowset
                    </a>
                </li>
                <li {% if page.url == '../classes/RowsetAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowsetAbstract.html">
                        RowsetAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Socket.html' %} class="active" {% endif %}>
                    <a href="../classes/Socket.html">
                        Socket
                    </a>
                </li>
                <li {% if page.url == '../classes/SqliteAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/SqliteAdapter.html">
                        SqliteAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/States.html' %} class="active" {% endif %}>
                    <a href="../classes/States.html">
                        States
                    </a>
                </li>
                <li {% if page.url == '../classes/Table.html' %} class="active" {% endif %}>
                    <a href="../classes/Table.html">
                        Table
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewAbstract.html">
                        ViewAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewJson.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewJson.html">
                        ViewJson
                    </a>
                </li>
        </ul>    </aside>

    <article>
        <h1 class="file-heading">File: lib/database/table/default.js</h1>
        
        <div class="file">
            <pre class="code prettyprint linenums">
        &quot;use strict&quot;;
        
        var Abstract        = require(&#x27;./abstract&#x27;),
            Inflector       = require(&#x27;../../inflector/inflector&#x27;),
            util            = require(&#x27;util&#x27;),
            CommandContext  = require(&#x27;../../command/context/context&#x27;);
        
        /**
         * Default table class
         *
         * @class Table
         * @extends ObjectManager
         * @constructor
         */
        function Table(config) {
            this._identity_column   = undefined;
            this._column_map        = {};
        
            Abstract.call(this, config);
        }
        
        util.inherits(Table, Abstract);
        
        /**
         * Initialize function to initialize the Table model
         *
         * @method initialze
         * @param {Object|null} config Config object for the Table object
         * @returns {Promise} The initialized Table object
         */
        Table.prototype.initialize = function (config) {
            var self = this;
            var extra = this.getComponentConfig(&#x27;table.&#x27; + this.getIdentifier().getName());
        
            this._identity_column = config.identity_column || extra.identity_column || null;
            this._column_map = config.column_map || {};
        
            this.db = config.db || extra.db || &#x27;default&#x27;;
            this.db_config = self.getConfig(&#x27;db&#x27;)[this.db];
            this.adapter = this.db_config.type || &#x27;mysql&#x27;;
            this.name = (self.db_config.prefix || &#x27;&#x27;) + (config.name || extra.name || self.getIdentifier().getPackage() + &#x27;_&#x27; + Inflector.pluralize(self.getIdentifier().getName()));
            this.filters = config.filters || extra.filters || {};
        
            config.behaviors = config.behaviors || extra.behaviors || {};
        
            if(this.db_config === undefined) {
                throw new RaddishError(500, &#x27;No config found for the &#x27; + this.db + &#x27; database adapter&#x27;);
            }
        
            return Table.super_.prototype.initialize.call(self, config)
                .then(function () {
                    // Now we will set the identity column.
                    return self.getIdentityColumn();
                })
                .then(function (identity_column) {
                    self._identity_column = self._identity_column || identity_column;
        
                    if (!self._column_map.id &amp;&amp; self._identity_column) {
                        self._column_map.id = self._identity_column;
                    }
        
                    return self;
                });
        };
        
        /**
         * This method tries to get get a row or rowset from the table.
         *
         * @method select
         * @param {String} query
         * @param {Int} mode Mode to get from the table.
         * @returns {Promise} The data requested from the database.
         */
        Table.prototype.select = function (query, mode) {
            var context     = new CommandContext();
            context.data    = undefined;
            context.table   = this.getName();
            context.query   = query;
            context.mode    = mode;
        
            return this.execute(&#x27;select&#x27;, context);
        };
        
        Table.prototype._beforeSelect = function(context) {
            return context;
        };
        
        Table.prototype._afterSelect = function(context) {
            var self = this;
            var object = undefined;
        
            if(context.mode === 1) {
                object = this.getRow();
            } else if(context.mode === 2) {
                object = this.getRowset();
            } else if(context.mode === 3) {
                object = Promise.cast({});
            } else {
                throw new RaddishError(500, &#x27;Unrecognised select mode.&#x27;);
            }
        
            return object
                .then(function(object) {
                    if(context.mode === 1) {
                        context.result = self.mapColumns(context.result[0], true);
                    } else if(context.mode === 2) {
                        for(var index in context.result) {
                            context.result[index] = self.mapColumns(context.result[index], true);
                        }
                    } else if(context.mode === 3) {
                        for(var index in context.result) {
                            context.result[index] = self.mapColumns(context.result[index], true);
                        }
        
                        return context.result;
                    }
        
                    return object.setData(context.result);
                })
                .then(function(object) {
                    if(context.mode === 1 &amp;&amp; object.getData().id !== null) {
                        object.new = false;
                    } else if(context.mode === 2 &amp;&amp; object.getData().length &gt; 0) {
                        for(var index in object.rows) {
                            object.rows[index].new = false;
                        }
                    }
        
                    context.result = object;
                    return context;
                });
        };
        
        /**
         * This method will try to insert a row in the database
         *
         * @method insert
         * @param {String} query The query string for the database
         * @return {Promise} The inserted data
         */
        Table.prototype.insert = function (row) {
            var self = this;
        
            var context     = new CommandContext();
            context.data    = row;
            context.table   = this.getName();
            context.query   = undefined;
        
            return this.getQuery()
                .then(function(query) {
                    context.query = query.insert();
        
                    return self.execute(&#x27;insert&#x27;, context);
                });
        };
        
        Table.prototype._beforeInsert = function(context) {
            var self = this;
        
            return this.getAdapter()
                .then(function(adapter) {
                    return [adapter, self.getColumns()];
                })
                .spread(function(adapter, columns) {
                    context.query.table(context.table);
        
                    self.filter(adapter, columns, context.data.data);
        
                    for(var index in context.data.data) {
                        if((adapter.strictColumns ? columns[index] : true) &amp;&amp; (adapter.strictColumns ? !columns[index].autoinc : true) &amp;&amp; (adapter.strictColumns ? context.data.data[index] : true)) {
                            context.query.set((adapter.strictColumns ? columns[index].name : index), context.data.data[index]);
                        }
                    }
        
                    return context;
                });
        };
        
        Table.prototype._afterInsert = function(context) {
            context.data.data = this.mapColumns(context.data.data, true);
            context.data.new = false;
        
            context.data.data.id = context.result.insertId;
            context.result = context.data;
        
            return context;
        };
        
        /**
         * This method will try to update a row in the database
         *
         * @method update
         * @param {String} query The query string for the database
         * @return {Promise} The updated data
         */
        Table.prototype.update = function (row) {
            var self = this;
        
            var context     = new CommandContext();
            context.data    = row;
            context.table   = this.getName();
            context.query   = undefined;
        
            return this.getQuery()
                .then(function(query) {
                    context.query = query.update();
        
                    return self.execute(&#x27;update&#x27;, context);
                });
        };
        
        Table.prototype._beforeUpdate = function(context) {
            var self = this;
        
            return this.getAdapter()
                .then(function(adapter) {
                    return [adapter, self.getColumns()];
                })
                .spread(function(adapter, columns) {
                    context.query.table(context.table);
        
                    // Here we filter both modified and data, this is because the data put into modified will also be put in data.
                    self.filter(adapter, columns, context.data.modified);
                    self.filter(adapter, columns, context.data.data);
        
                    for(var index in context.data.modified) {
                        if((adapter.strictColumns ? columns[index] : true) &amp;&amp; (adapter.strictColumns ? !columns[index].autoinc : true) &amp;&amp; (adapter.strictColumns ? context.data.data[index] !== false : true)) {
                            context.query.set((adapter.strictColumns ? columns[index].name : index), context.data.modified[index]);
                        }
                    }
        
                    for(var index in columns) {
                        if(columns[index].unique &amp;&amp; context.data.data[index] &amp;&amp; !context.data.modified[index]) {
                            context.query.where(columns[index].name, &#x27;=&#x27;, context.data.data[index]);
                        }
                    }
        
                    return context;
                });
        };
        
        Table.prototype._afterUpdate = function(context) {
            context.data.data = this.mapColumns(context.data.data, true);
            context.result = context.data;
        
            return context;
        };
        
        /**
         * This method will try to delete a row in the database
         *
         * @method delete
         * @param {String} query The query string for the database
         * @return {Promise} The deleted data
         */
        Table.prototype.delete = function (row) {
            var self = this;
        
            var context     = new CommandContext();
            context.data    = row;
            context.table   = this.getName();
            context.query   = undefined;
        
            return this.getQuery()
                .then(function(query) {
                    context.query = query.delete();
        
                    return self.execute(&#x27;delete&#x27;, context);
                });
        };
        
        Table.prototype._beforeDelete = function(context) {
            return this.getUniqueColumns()
                .then(function(columns) {
                    context.query.table(context.table);
        
                    for(var index in columns) {
                        context.query.where(columns[index].name, &#x27;=&#x27;, context.data.data[index]);
                    }
        
                    return context;
                });
        };
        
        Table.prototype._afterDelete = function(context) {
            context.result = this.mapColumns(context.data, true);
        
            return context;
        };
        
        /**
         * This function will filter the data based on the columns.
         * And will check if the value is correct.
         *
         * @method filter
         * @param {Object} adapter The adapter object.
         * @param {Object} columns The object containing all the columns.
         * @param {Object} data The data object.
         * @private
         */
        Table.prototype.filter = function(adapter, columns, data) {
            var strict = adapter.strictColumns;
        
            for(var index in data) {
                if((strict ? columns[index] : false) &amp;&amp; columns[index].filter.validate(data[index])) {
                    data[index] = columns[index].filter.sanitize(data[index]);
                } else if(strict &amp;&amp; !columns[index]) {
                    // If everything is ok this is a pointer.
                    delete data[index];
                }
            }
        };
        
        /**
         * The getQuery method returns the query received from the associated adapter (default: mysql).
         *
         * @method getQuery
         * @returns {Object} The queryBuilder object.
         */
        Table.prototype.getQuery = function() {
            return this.getAdapter()
                .then(function(adapter) {
                    return adapter.getQuery();
                });
        };
        
        module.exports = Table;
        
            </pre>
        </div>
    </article>
</div>