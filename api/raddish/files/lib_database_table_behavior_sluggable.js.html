---
layout: default
---

<div class="api">
    <aside class="sidebar">
        <ul>
                <li {% if page.url == '../classes/AbstractAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractAdapter.html">
                        AbstractAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/AbstractDispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractDispatcher.html">
                        AbstractDispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Application.html' %} class="active" {% endif %}>
                    <a href="../classes/Application.html">
                        Application
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandBehavior.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandBehavior.html">
                        CommandBehavior
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandChain.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandChain.html">
                        CommandChain
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandContext.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandContext.html">
                        CommandContext
                    </a>
                </li>
                <li {% if page.url == '../classes/Controller.html' %} class="active" {% endif %}>
                    <a href="../classes/Controller.html">
                        Controller
                    </a>
                </li>
                <li {% if page.url == '../classes/ControllerAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ControllerAbstract.html">
                        ControllerAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/DefaultAuthenticator.html' %} class="active" {% endif %}>
                    <a href="../classes/DefaultAuthenticator.html">
                        DefaultAuthenticator
                    </a>
                </li>
                <li {% if page.url == '../classes/Dispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/Dispatcher.html">
                        Dispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Inflector.html' %} class="active" {% endif %}>
                    <a href="../classes/Inflector.html">
                        Inflector
                    </a>
                </li>
                <li {% if page.url == '../classes/Mixin.html' %} class="active" {% endif %}>
                    <a href="../classes/Mixin.html">
                        Mixin
                    </a>
                </li>
                <li {% if page.url == '../classes/Model.html' %} class="active" {% endif %}>
                    <a href="../classes/Model.html">
                        Model
                    </a>
                </li>
                <li {% if page.url == '../classes/ModelAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ModelAbstract.html">
                        ModelAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/MongoAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MongoAdapter.html">
                        MongoAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/MysqlAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MysqlAdapter.html">
                        MysqlAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectIdentifier.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectIdentifier.html">
                        ObjectIdentifier
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectLoader.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectLoader.html">
                        ObjectLoader
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectManager.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectManager.html">
                        ObjectManager
                    </a>
                </li>
                <li {% if page.url == '../classes/Plugin.html' %} class="active" {% endif %}>
                    <a href="../classes/Plugin.html">
                        Plugin
                    </a>
                </li>
                <li {% if page.url == '../classes/RaddishError.html' %} class="active" {% endif %}>
                    <a href="../classes/RaddishError.html">
                        RaddishError
                    </a>
                </li>
                <li {% if page.url == '../classes/Role.html' %} class="active" {% endif %}>
                    <a href="../classes/Role.html">
                        Role
                    </a>
                </li>
                <li {% if page.url == '../classes/Router.html' %} class="active" {% endif %}>
                    <a href="../classes/Router.html">
                        Router
                    </a>
                </li>
                <li {% if page.url == '../classes/Row.html' %} class="active" {% endif %}>
                    <a href="../classes/Row.html">
                        Row
                    </a>
                </li>
                <li {% if page.url == '../classes/RowAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowAbstract.html">
                        RowAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Rowset.html' %} class="active" {% endif %}>
                    <a href="../classes/Rowset.html">
                        Rowset
                    </a>
                </li>
                <li {% if page.url == '../classes/RowsetAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowsetAbstract.html">
                        RowsetAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Socket.html' %} class="active" {% endif %}>
                    <a href="../classes/Socket.html">
                        Socket
                    </a>
                </li>
                <li {% if page.url == '../classes/SqliteAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/SqliteAdapter.html">
                        SqliteAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/States.html' %} class="active" {% endif %}>
                    <a href="../classes/States.html">
                        States
                    </a>
                </li>
                <li {% if page.url == '../classes/Table.html' %} class="active" {% endif %}>
                    <a href="../classes/Table.html">
                        Table
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewAbstract.html">
                        ViewAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewJson.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewJson.html">
                        ViewJson
                    </a>
                </li>
        </ul>    </aside>

    <article>
        <h1 class="file-heading">File: lib/database/table/behavior/sluggable.js</h1>
        
        <div class="file">
            <pre class="code prettyprint linenums">
        var Abstract    = require(&#x27;../../../command/behavior/behavior&#x27;),
            util        = require(&#x27;util&#x27;),
            Filter      = require(&#x27;../../../filter/filter&#x27;);
        
        /**
         * The sluggable bahavior will automatically add the slug.
         * The slug to be created will be based on the column config value, if none is given the default will be the title column
         *
         * @constructor
         */
        function SluggableBehavior(config) {
            Abstract.call(this, config);
        }
        
        util.inherits(SluggableBehavior, Abstract);
        
        SluggableBehavior.prototype.initialize = function(config) {
            if(!config.column) {
                config.column = &#x27;title&#x27;;
            }
        
            return Abstract.prototype.initialize.call(this, config);
        };
        
        SluggableBehavior.prototype.onAfterInsert = function(context) {
            return this.onAfterUpdate(context);
        };
        
        SluggableBehavior.prototype.onAfterUpdate = function(context) {
            var self    = this;
            var query   = {};
            var filter  = Filter.getFilter(&#x27;slug&#x27;);
            var table   = context.data.getTable();
        
            if(context.data.data[this.config.column] &amp;&amp; Object.keys(context.data.data).indexOf(&#x27;slug&#x27;) &gt; -1) {
                var slug = Filter.getFilter(&#x27;slug&#x27;).sanitize(context.data.data[this.config.column]);
        
                return context.data.getTable()
                    .then(function(table) {
                        return [table, table.getQuery()];
                    })
                    .spread(function(table, query) {
                        var select_query = query.select();
                        select_query.table(table.getName()).where(&#x27;slug&#x27;, &#x27;LIKE&#x27;, slug);
        
                        return [table.select(select_query, 2, true), table, query];
                    })
                    .spread(function(data, table, query) {
                        return [data, table, query];
                    })
                    .spread(function(data, table, query) {
                        if(data.rows.length === 0) {
                            context.data.setData({slug: slug});
        
                            return context;
                        } else {
                            return self.createSlug(context, table, query, slug);
                        }
                    })
                    .then(function(context) {
                        self.save(context);
                    });
            } else {
                return Promise.resolve(context);
            }
        };
        
        SluggableBehavior.prototype.createSlug = function(context, table, query, slug) {
            var select_query = query.select();
            select_query.table(table.getName()).where(&#x27;slug&#x27;, &#x27;LIKE&#x27;, slug + &#x27;-%&#x27;);
        
            return table.select(select_query, 2)
                .then(function(data) {
                    var slugs = [];
                    var i = 1;
        
                    for(var index in data.rows) {
                        slugs.push(data.rows[index].data.slug);
                    }
        
                    while(slugs.indexOf(slug + &#x27;-&#x27; + i) &gt; -1) {
                        i++;
                    }
        
                    context.data.setData({slug: slug + &#x27;-&#x27; + i});
        
                    return context;
                });
        };
        
        module.exports = SluggableBehavior;
            </pre>
        </div>
    </article>
</div>