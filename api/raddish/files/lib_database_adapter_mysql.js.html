---
layout: default
---

<div class="api">
    <aside class="sidebar">
        <ul>
                <li {% if page.url == '../classes/AbstractAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractAdapter.html">
                        AbstractAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/AbstractDispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/AbstractDispatcher.html">
                        AbstractDispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Application.html' %} class="active" {% endif %}>
                    <a href="../classes/Application.html">
                        Application
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandBehavior.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandBehavior.html">
                        CommandBehavior
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandChain.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandChain.html">
                        CommandChain
                    </a>
                </li>
                <li {% if page.url == '../classes/CommandContext.html' %} class="active" {% endif %}>
                    <a href="../classes/CommandContext.html">
                        CommandContext
                    </a>
                </li>
                <li {% if page.url == '../classes/Controller.html' %} class="active" {% endif %}>
                    <a href="../classes/Controller.html">
                        Controller
                    </a>
                </li>
                <li {% if page.url == '../classes/ControllerAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ControllerAbstract.html">
                        ControllerAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/DefaultAuthenticator.html' %} class="active" {% endif %}>
                    <a href="../classes/DefaultAuthenticator.html">
                        DefaultAuthenticator
                    </a>
                </li>
                <li {% if page.url == '../classes/Dispatcher.html' %} class="active" {% endif %}>
                    <a href="../classes/Dispatcher.html">
                        Dispatcher
                    </a>
                </li>
                <li {% if page.url == '../classes/Inflector.html' %} class="active" {% endif %}>
                    <a href="../classes/Inflector.html">
                        Inflector
                    </a>
                </li>
                <li {% if page.url == '../classes/Mixin.html' %} class="active" {% endif %}>
                    <a href="../classes/Mixin.html">
                        Mixin
                    </a>
                </li>
                <li {% if page.url == '../classes/Model.html' %} class="active" {% endif %}>
                    <a href="../classes/Model.html">
                        Model
                    </a>
                </li>
                <li {% if page.url == '../classes/ModelAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ModelAbstract.html">
                        ModelAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/MongoAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MongoAdapter.html">
                        MongoAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/MysqlAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/MysqlAdapter.html">
                        MysqlAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectIdentifier.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectIdentifier.html">
                        ObjectIdentifier
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectLoader.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectLoader.html">
                        ObjectLoader
                    </a>
                </li>
                <li {% if page.url == '../classes/ObjectManager.html' %} class="active" {% endif %}>
                    <a href="../classes/ObjectManager.html">
                        ObjectManager
                    </a>
                </li>
                <li {% if page.url == '../classes/Plugin.html' %} class="active" {% endif %}>
                    <a href="../classes/Plugin.html">
                        Plugin
                    </a>
                </li>
                <li {% if page.url == '../classes/RaddishError.html' %} class="active" {% endif %}>
                    <a href="../classes/RaddishError.html">
                        RaddishError
                    </a>
                </li>
                <li {% if page.url == '../classes/Role.html' %} class="active" {% endif %}>
                    <a href="../classes/Role.html">
                        Role
                    </a>
                </li>
                <li {% if page.url == '../classes/Router.html' %} class="active" {% endif %}>
                    <a href="../classes/Router.html">
                        Router
                    </a>
                </li>
                <li {% if page.url == '../classes/Row.html' %} class="active" {% endif %}>
                    <a href="../classes/Row.html">
                        Row
                    </a>
                </li>
                <li {% if page.url == '../classes/RowAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowAbstract.html">
                        RowAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Rowset.html' %} class="active" {% endif %}>
                    <a href="../classes/Rowset.html">
                        Rowset
                    </a>
                </li>
                <li {% if page.url == '../classes/RowsetAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/RowsetAbstract.html">
                        RowsetAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/Socket.html' %} class="active" {% endif %}>
                    <a href="../classes/Socket.html">
                        Socket
                    </a>
                </li>
                <li {% if page.url == '../classes/SqliteAdapter.html' %} class="active" {% endif %}>
                    <a href="../classes/SqliteAdapter.html">
                        SqliteAdapter
                    </a>
                </li>
                <li {% if page.url == '../classes/States.html' %} class="active" {% endif %}>
                    <a href="../classes/States.html">
                        States
                    </a>
                </li>
                <li {% if page.url == '../classes/Table.html' %} class="active" {% endif %}>
                    <a href="../classes/Table.html">
                        Table
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewAbstract.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewAbstract.html">
                        ViewAbstract
                    </a>
                </li>
                <li {% if page.url == '../classes/ViewJson.html' %} class="active" {% endif %}>
                    <a href="../classes/ViewJson.html">
                        ViewJson
                    </a>
                </li>
        </ul>    </aside>

    <article>
        <h1 class="file-heading">File: lib/database/adapter/mysql.js</h1>
        
        <div class="file">
            <pre class="code prettyprint linenums">
        &quot;use strict&quot;;
        
        var AbstractAdapter = require(&#x27;./abstract&#x27;),
            util            = require(&#x27;util&#x27;),
            query           = require(&#x27;universal-query&#x27;),
            mysql           = require(&#x27;mysql&#x27;),
            instances       = {},
            Filter          = require(&#x27;../../filter/filter&#x27;);
        
        /**
         * The MysqlAdapter is the default adapter in this framework,
         * this sets the queryBuilder object with the &quot;squel&quot; module which is a query builder for mysql.
         *
         * @class MysqlAdapter
         * @extends AbstractAdapter
         * @constructor
         */
        function MysqlAdapter(config, connection) {
            MysqlAdapter.super_.call(this, config);
            this.connection = connection;
        
            this.queryBuilder = query.getType(&#x27;mysql&#x27;);
        }
        
        util.inherits(MysqlAdapter, AbstractAdapter);
        
        MysqlAdapter.prototype.types = {
            // Numeric
            &#x27;int&#x27;               : &#x27;int&#x27;,
            &#x27;integer&#x27;           : &#x27;int&#x27;,
            &#x27;bigint&#x27;            : &#x27;int&#x27;,
            &#x27;mediumint&#x27;			: &#x27;int&#x27;,
            &#x27;smallint&#x27;			: &#x27;int&#x27;,
            &#x27;tinyint&#x27;			: &#x27;int&#x27;,
            &#x27;numeric&#x27;			: &#x27;int&#x27;,
            &#x27;dec&#x27;               : &#x27;int&#x27;,
            &#x27;decimal&#x27;           : &#x27;int&#x27;,
            &#x27;float&#x27;				: &#x27;int&#x27;,
            &#x27;double&#x27;            : &#x27;int&#x27;,
            &#x27;real&#x27; 				: &#x27;int&#x27;,
        
            // boolean
            &#x27;bool&#x27;				: &#x27;boolean&#x27;,
            &#x27;boolean&#x27; 			: &#x27;boolean&#x27;,
        
            // date &amp; time
            &#x27;date&#x27;              : &#x27;date&#x27;,
            &#x27;time&#x27;              : &#x27;time&#x27;,
            &#x27;datetime&#x27;          : &#x27;int&#x27;,
            &#x27;timestamp&#x27;         : &#x27;int&#x27;,
            &#x27;year&#x27;				: &#x27;int&#x27;,
        
            // string
            &#x27;national char&#x27;     : &#x27;string&#x27;,
            &#x27;nchar&#x27;             : &#x27;string&#x27;,
            &#x27;char&#x27;              : &#x27;string&#x27;,
            &#x27;binary&#x27;            : &#x27;string&#x27;,
            &#x27;national varchar&#x27;  : &#x27;string&#x27;,
            &#x27;nvarchar&#x27;          : &#x27;string&#x27;,
            &#x27;varchar&#x27;           : &#x27;string&#x27;,
            &#x27;varbinary&#x27;         : &#x27;string&#x27;,
            &#x27;text&#x27;				: &#x27;string&#x27;,
            &#x27;mediumtext&#x27;		: &#x27;string&#x27;,
            &#x27;tinytext&#x27;			: &#x27;string&#x27;,
            &#x27;longtext&#x27;			: &#x27;string&#x27;,
        
            // blob
            &#x27;blob&#x27;				: &#x27;raw&#x27;,
            &#x27;tinyblob&#x27;			: &#x27;raw&#x27;,
            &#x27;mediumblob&#x27;		: &#x27;raw&#x27;,
            &#x27;longblob&#x27;          : &#x27;raw&#x27;,
        
            //other
            &#x27;set&#x27;				: &#x27;string&#x27;,
            &#x27;enum&#x27;				: &#x27;string&#x27;,
        };
        
        /**
         * This method will return an instance of the mysql connection,
         * If there is a problem with the connection an error will be thrown.
         *
         * @method getInstance
         * @param name
         * @param config
         * @returns {Object} A resolved promise with the connection.
         */
        MysqlAdapter.prototype.getInstance = function(name, config) {
            var self = this;
        
            if (instances[name]) {
                return Promise.resolve(instances[name]);
            } else {
                var options = {
                    host: config.host,
                    user: config.user,
                    password: config.password,
                    database: config.database,
                    port: config.port || 3306
                };
        
                var connection = mysql.createConnection(options);
                
                return new Promise(function(resolve, reject) {
                    connection.connect(function(err) {
                        if(err) {
                            return reject(err);
                        }
                        
                        return resolve(connection);
                    })
                }).then(function(connection) {
                    instances[name] = new MysqlAdapter({
                        identifier: self.getIdentifier()
                    }, connection);
        
                    return instances[name];
                }).catch(function(error) {
                    throw new RaddishError(500, error.message);
                });
            }
        };
        
        /**
         * This method will execute a query on the server.
         *
         * @method execute
         * @param {Object} query The query object to execute.
         * @returns {Promise} The promise with all the data returned from the server.
         */
        MysqlAdapter.prototype.execute = function(query) {
            var self = this;
            
            return new Promise(function(resolve, reject) {
                self.connection.query(query.toQuery(), function(err, rows) {
                    if(err) {
                        return reject(err);
                    }
                    
                    return resolve(rows);
                });
            }).catch(function(error) {
                throw new RaddishError(500, error.message);
            });
        };
        
        /**
         * This method will create the schema to use.
         *
         * @method getSchema
         * @param {String} name The name of the table to get the schema from.
         * @returns {Promise} The promise containing the schema.
         */
        MysqlAdapter.prototype.getSchema = function(name) {
            var result = {};
            var self = this;
        
            return this._fetchInfo(name)
                .then(function(info) {
                    result.info = info;
                    
                    return self._fetchIndexes(name);
                })
                .then(function(indexes) {
                    result.indexes = indexes;
                    
                    return self._fetchColumns(name);
                })
                .then(function(columns) {
                    result.columns = columns;
                    
                    return result;
                });
        
        };
        
        /**
         * This method will receive various information of the server.
         *
         * @method _fetchInfo
         * @param {String} name The table name from which to return the data.
         * @returns {Promise} The promise with the server information.
         * @private
         */
        MysqlAdapter.prototype._fetchInfo = function(name) {
            var self = this;
            var table = &#x27;\&#x27;&#x27; + name + &#x27;\&#x27;&#x27;;
            
            return new Promise(function(resolve, reject) {
                self.connection.query(&#x27;SHOW TABLE STATUS LIKE &#x27; + table, function(err, rows) {
                    if(err) {
                        return reject(err);
                    }
                    
                    return resolve(rows);
                });
            }).then(function(result) {
                result = result[0];
        
                return {
                    name: result.Name,
                    engine: result.Engine,
                    type: result.Comment == &#x27;VIEW&#x27; ? &#x27;VIEW&#x27; : &#x27;BASE&#x27;,
                    length: result.Data_length,
                    autoinc: result.Auto_increment,
                    collation: result.collation,
                    description: result.Comment != &#x27;VIEW&#x27; ? result.Comment : &#x27;&#x27;
                };
            }).catch(function(error) {
                throw new RaddishError(500, &#x27;Table: &#x27; + table + &#x27; does not exist&#x27;);
            });
        };
        
        /**
         * This function will return the indexes on the selected table.
         *
         * @method _fetchIndexes
         * @param {String} name The table name to get the indexed from
         * @returns {Promse} The promise with all the information.
         * @private
         */
        MysqlAdapter.prototype._fetchIndexes = function(name) {
            var self = this;
            
            return new Promise(function(resolve, reject) {
                self.connection.query(&#x27;SHOW INDEX FROM &#x60;&#x27; + name + &#x27;&#x60;&#x27;, function(err, rows) {
                    if(err) {
                        return reject(err);
                    }
                    
                    return resolve(rows);
                });
            }).then(function(indexes) {
                var result = {};
        
                for(var index in indexes) {
                    var indx = indexes[index];
                    
                    if(!result[indx.Key_name]) {
                        result[indx.Key_name] = {};
                    }
                    
                    result[indx.Key_name][indx.Seq_in_index] = indx;
                }
        
                return result;
            });
        };
        
        /**
         * This method will return the column layout.
         * This column layout will be used in the data responses.
         *
         * @param {String} name The name of the table to get the columns from.
         * @returns {Promise} The promise with the table columns.
         * @private
         */
        MysqlAdapter.prototype._fetchColumns = function(name) {
            var self = this;
        
            return new Promise(function(resolve, reject) {
                self.connection.query(&#x27;SHOW FULL COLUMNS FROM &#x27; + name, function(err, rows) {
                    if(err) {
                        return reject(err);
                    }
                    
                    return resolve(rows);
                });
            }).then(function(rows) {
                var result = {};
                    
                for(var index in rows) {
                    var filter = rows[index].Comment ? Filter.getFilter(rows[index].Comment.match(/@Filter\(&quot;(.*)&quot;\)/)[1]) : undefined;
        
                    result[rows[index].Field] = {
                        name: rows[index].Field,
                        unique: (rows[index].Key == &#x27;PRI&#x27; || rows[index].Key == &#x27;UNI&#x27;) ? 1 : 0,
                        autoinc: (rows[index].Extra.indexOf(&#x27;auto_increment&#x27;) != -1) ? 1 : 0,
                        value: rows[index].Default,
                        type: self.getType(rows[index].Type),
                        filter: filter || Filter.getFilter(self.getType(rows[index].Type))
                    };
                }
        
                return result;
            });
        };
        
        /**
         * This function will define the type of the column data.
         *
         * @param {Object} item the item to get the type from.
         * @returns {String} The object type.
         * @private
         */
        MysqlAdapter.prototype.getType = function(type) {
            type = type.toLowerCase();
        
            if(type.indexOf(&#x27;(&#x27;) &gt; -1) {
                type = type.split(&#x27;(&#x27;)[0];
            }
        
            return this.types[type];
        };
        
        module.exports = MysqlAdapter;
            </pre>
        </div>
    </article>
</div>