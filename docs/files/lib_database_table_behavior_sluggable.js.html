---
title: lib/database/table/behavior/sluggable.js - Raddish API
category: api
layout: default
---

<div class="row">
    <div class="col-md-3">
        <h1>Classes</h1>
        
        <ul class="nav nav-pills nav-stacked">
                <li {% if page.url == '/docs/classes/AbstractAdapter.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/AbstractAdapter.html">AbstractAdapter</a>
                </li>
                <li {% if page.url == '/docs/classes/AbstractDispatcher.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/AbstractDispatcher.html">AbstractDispatcher</a>
                </li>
                <li {% if page.url == '/docs/classes/Application.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Application.html">Application</a>
                </li>
                <li {% if page.url == '/docs/classes/CommandBehavior.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/CommandBehavior.html">CommandBehavior</a>
                </li>
                <li {% if page.url == '/docs/classes/CommandChain.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/CommandChain.html">CommandChain</a>
                </li>
                <li {% if page.url == '/docs/classes/CommandContext.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/CommandContext.html">CommandContext</a>
                </li>
                <li {% if page.url == '/docs/classes/Controller.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Controller.html">Controller</a>
                </li>
                <li {% if page.url == '/docs/classes/ControllerAbstract.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ControllerAbstract.html">ControllerAbstract</a>
                </li>
                <li {% if page.url == '/docs/classes/DefaultAuthenticator.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/DefaultAuthenticator.html">DefaultAuthenticator</a>
                </li>
                <li {% if page.url == '/docs/classes/Dispatcher.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Dispatcher.html">Dispatcher</a>
                </li>
                <li {% if page.url == '/docs/classes/Inflector.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Inflector.html">Inflector</a>
                </li>
                <li {% if page.url == '/docs/classes/Mixin.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Mixin.html">Mixin</a>
                </li>
                <li {% if page.url == '/docs/classes/Model.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Model.html">Model</a>
                </li>
                <li {% if page.url == '/docs/classes/ModelAbstract.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ModelAbstract.html">ModelAbstract</a>
                </li>
                <li {% if page.url == '/docs/classes/MongoAdapter.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/MongoAdapter.html">MongoAdapter</a>
                </li>
                <li {% if page.url == '/docs/classes/MysqlAdapter.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/MysqlAdapter.html">MysqlAdapter</a>
                </li>
                <li {% if page.url == '/docs/classes/ObjectIdentifier.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ObjectIdentifier.html">ObjectIdentifier</a>
                </li>
                <li {% if page.url == '/docs/classes/ObjectLoader.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ObjectLoader.html">ObjectLoader</a>
                </li>
                <li {% if page.url == '/docs/classes/ObjectManager.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ObjectManager.html">ObjectManager</a>
                </li>
                <li {% if page.url == '/docs/classes/Plugin.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Plugin.html">Plugin</a>
                </li>
                <li {% if page.url == '/docs/classes/RaddishError.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/RaddishError.html">RaddishError</a>
                </li>
                <li {% if page.url == '/docs/classes/Role.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Role.html">Role</a>
                </li>
                <li {% if page.url == '/docs/classes/Router.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Router.html">Router</a>
                </li>
                <li {% if page.url == '/docs/classes/Row.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Row.html">Row</a>
                </li>
                <li {% if page.url == '/docs/classes/RowAbstract.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/RowAbstract.html">RowAbstract</a>
                </li>
                <li {% if page.url == '/docs/classes/Rowset.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Rowset.html">Rowset</a>
                </li>
                <li {% if page.url == '/docs/classes/RowsetAbstract.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/RowsetAbstract.html">RowsetAbstract</a>
                </li>
                <li {% if page.url == '/docs/classes/Socket.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Socket.html">Socket</a>
                </li>
                <li {% if page.url == '/docs/classes/SqliteAdapter.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/SqliteAdapter.html">SqliteAdapter</a>
                </li>
                <li {% if page.url == '/docs/classes/States.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/States.html">States</a>
                </li>
                <li {% if page.url == '/docs/classes/Table.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Table.html">Table</a>
                </li>
                <li {% if page.url == '/docs/classes/ViewAbstract.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ViewAbstract.html">ViewAbstract</a>
                </li>
                <li {% if page.url == '/docs/classes/ViewJson.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ViewJson.html">ViewJson</a>
                </li>
        </ul>    </div>
    <div class="col-md-9">
        <h1>File: lib/database/table/behavior/sluggable.js</h1>
        
        
        {% highlight javascript linenos %}
        var Abstract    = require('../../../command/behavior/behavior');
        var util        = require('util');
        var Filter      = require('../../../filter/filter');
        
        /**
         * The sluggable bahavior will automatically add the slug.
         * The slug to be created will be based on the column config value, if none is given the default will be the title column
         *
         * @constructor
         */
        function SluggableBehavior(config) {
            Abstract.call(this, config);
        }
        
        util.inherits(SluggableBehavior, Abstract);
        
        SluggableBehavior.prototype.initialize = function(config) {
            if(!config.column) {
                config.column = 'title';
            }
        
            return Abstract.prototype.initialize.call(this, config);
        };
        
        SluggableBehavior.prototype.onBeforeInsert = function(context) {
            return this.onBeforeUpdate(context);
        }
        
        SluggableBehavior.prototype.onBeforeUpdate = function(context) {
            var self    = this;
            var query   = {};
            var filter  = Filter.getFilter('slug');
            var table   = context.data.getTable();
        
            if(context.data.data[this.config.column] && Object.keys(context.data.data).indexOf('slug') > -1) {
                var slug = Filter.getFilter('slug').sanitize(context.data.data[this.config.column]);
        
                return context.data.getTable()
                    .then(function(table) {
                        return [table, table.getQuery()];
                    })
                    .spread(function(table, query) {
                        var select_query = query.select();
                        select_query.table(table.getName()).where('slug', 'LIKE', slug);
        
                        return [table.select(select_query, 2), table, query];
                    })
                    .spread(function(data, table, query) {
                        if(data.rows.length === 0) {
                            context.data.data.slug = slug;
        
                            return context;
                        } else {
                            return self.createSlug(context, table, query, slug);
                        }
                    });
            } else {
                return Promise.resolve(context);
            }
        };
        
        SluggableBehavior.prototype.createSlug = function(context, table, query, slug) {
            var select_query = query.select();
            select_query.table(table.getName()).where('slug', 'LIKE', slug + '-%');
        
            return table.select(select_query, 2)
                .then(function(data) {
                    var slugs = [];
                    var i = 1;
        
                    for(var index in data.rows) {
                        slugs.push(data.rows[index].data.slug);
                    }
        
                    while(slugs.indexOf(slug + '-' + i) > -1) {
                        i++;
                    }
        
                    context.data.data.slug = slug + '-' + i;
        
                    return context;
                });
        }
        
        module.exports = SluggableBehavior;
        {% endhighlight %}    </div>
</div>