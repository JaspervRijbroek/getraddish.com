---
title: lib/threads/threads.js - Raddish API
category: api
layout: default
---

<div class="row">
    <div class="col-md-3">
        <h1>Classes</h1>
        
        <ul class="nav nav-pills nav-stacked">
                <li {% if page.url == '/docs/classes/AbstractAdapter.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/AbstractAdapter.html">AbstractAdapter</a>
                </li>
                <li {% if page.url == '/docs/classes/AbstractDispatcher.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/AbstractDispatcher.html">AbstractDispatcher</a>
                </li>
                <li {% if page.url == '/docs/classes/Application.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Application.html">Application</a>
                </li>
                <li {% if page.url == '/docs/classes/CommandBehavior.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/CommandBehavior.html">CommandBehavior</a>
                </li>
                <li {% if page.url == '/docs/classes/CommandChain.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/CommandChain.html">CommandChain</a>
                </li>
                <li {% if page.url == '/docs/classes/CommandContext.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/CommandContext.html">CommandContext</a>
                </li>
                <li {% if page.url == '/docs/classes/Controller.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Controller.html">Controller</a>
                </li>
                <li {% if page.url == '/docs/classes/ControllerAbstract.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ControllerAbstract.html">ControllerAbstract</a>
                </li>
                <li {% if page.url == '/docs/classes/DefaultAuthenticator.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/DefaultAuthenticator.html">DefaultAuthenticator</a>
                </li>
                <li {% if page.url == '/docs/classes/Dispatcher.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Dispatcher.html">Dispatcher</a>
                </li>
                <li {% if page.url == '/docs/classes/Inflector.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Inflector.html">Inflector</a>
                </li>
                <li {% if page.url == '/docs/classes/Mixin.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Mixin.html">Mixin</a>
                </li>
                <li {% if page.url == '/docs/classes/Model.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Model.html">Model</a>
                </li>
                <li {% if page.url == '/docs/classes/ModelAbstract.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ModelAbstract.html">ModelAbstract</a>
                </li>
                <li {% if page.url == '/docs/classes/MongoAdapter.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/MongoAdapter.html">MongoAdapter</a>
                </li>
                <li {% if page.url == '/docs/classes/MysqlAdapter.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/MysqlAdapter.html">MysqlAdapter</a>
                </li>
                <li {% if page.url == '/docs/classes/ObjectIdentifier.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ObjectIdentifier.html">ObjectIdentifier</a>
                </li>
                <li {% if page.url == '/docs/classes/ObjectLoader.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ObjectLoader.html">ObjectLoader</a>
                </li>
                <li {% if page.url == '/docs/classes/ObjectManager.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ObjectManager.html">ObjectManager</a>
                </li>
                <li {% if page.url == '/docs/classes/Plugin.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Plugin.html">Plugin</a>
                </li>
                <li {% if page.url == '/docs/classes/RaddishError.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/RaddishError.html">RaddishError</a>
                </li>
                <li {% if page.url == '/docs/classes/Role.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Role.html">Role</a>
                </li>
                <li {% if page.url == '/docs/classes/Router.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Router.html">Router</a>
                </li>
                <li {% if page.url == '/docs/classes/Row.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Row.html">Row</a>
                </li>
                <li {% if page.url == '/docs/classes/RowAbstract.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/RowAbstract.html">RowAbstract</a>
                </li>
                <li {% if page.url == '/docs/classes/Rowset.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Rowset.html">Rowset</a>
                </li>
                <li {% if page.url == '/docs/classes/RowsetAbstract.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/RowsetAbstract.html">RowsetAbstract</a>
                </li>
                <li {% if page.url == '/docs/classes/Socket.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Socket.html">Socket</a>
                </li>
                <li {% if page.url == '/docs/classes/SqliteAdapter.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/SqliteAdapter.html">SqliteAdapter</a>
                </li>
                <li {% if page.url == '/docs/classes/States.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/States.html">States</a>
                </li>
                <li {% if page.url == '/docs/classes/Table.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/Table.html">Table</a>
                </li>
                <li {% if page.url == '/docs/classes/ViewAbstract.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ViewAbstract.html">ViewAbstract</a>
                </li>
                <li {% if page.url == '/docs/classes/ViewJson.html' %} class="active" {% endif %}>
                    <a href="/docs/classes/ViewJson.html">ViewJson</a>
                </li>
        </ul>    </div>
    <div class="col-md-9">
        <h1>File: lib/threads/threads.js</h1>
        
        
        {% highlight javascript linenos %}
        "use strict";
        
        /**
         * The Threads class will scale the amount of processes when the load is higher.
         * This will be done completely automatic.
         *
         * And in the config file you can turn this on or off and set more data.
         * This must scale automatically.
         *
         * Also this class will be a little bit like cluster2.
         *
         * If a process activity is higher than 50% we will spawn a new process to lighten the tasks.
         */
        var cluster = require('cluster');
        var usage   = Promise.promisifyAll(require('usage'));
        var threads = [];
        var config = {
            maxThreads: 16,
            maxThreshold: 50,
            minThreshold: 10,
            interval: 500
        }
        var master = undefined;
        
        /**
         * This object is automatically started when thread support is enabled.
         *
         * @constructor
         */
        function Threads() {
            var threadsConfig = Raddish.getConfig('threads');
            var isWin = /^win/.test(process.platform);
        
            if(threadsConfig !== false && !isWin) {
                if(cluster.isMaster) {
                    console.log('Threads support enabled!');
        
                    master = cluster;
                    threads.push(cluster.fork());
                }
        
                if(threadsConfig.maxThreads) {
                    config.maxThreads = threadsConfig.maxThreads;
                }
        
                if(threadsConfig.maxThreshold) {
                    config.maxThreshold = threadsConfig.maxThreshold;
                }
        
                if(threadsConfig.minThreshold) {
                    config.minThreshold = threadsConfig.minThreshold;
                }
        
                if(threadsConfig.interval) {
                    config.interval = threadsConfig.interval
                }
        
                setInterval(this.checkThreads, config.interval);
            } else if(threadsConfig !== false && isWin) {
                console.log('Threads not supported in Windows');
            }
        };
        
        /**
         * This method will check the registred threads and if the thread is too busy
         * another thread will be spawn automatically.
         *
         * When the threads are not busy at all, the last added thread will be closed automatically.
         *
         * @method checkThreads
         */
        Threads.prototype.checkThreads = function() {
            // We will hold our own threads.
            var mean        = 0;
            var total       = threads.length;
            var collection  = [];
        
            for(var index in threads) {
                var thread = threads[index];
        
                collection.push(
                    usage.lookupAsync(thread.process.pid)
                        .then(function(result) {
                            mean += result.cpu;
                        })
                );
            }
        
            Promise.all(collection)
                .then(function() {
                    if((mean / total) > config.maxThreshold && total < config.maxThreads) {
        
                        console.log('Spawning new process!');
                        threads.push(master.fork());
                    } else if((mean / total) < config.minThreshold && total > 1) {
                        var thread = threads.pop();
        
                        console.log('Killing process!');
                        thread.kill();
                    }
                });
        };
        
        module.exports = new Threads();
        {% endhighlight %}    </div>
</div>